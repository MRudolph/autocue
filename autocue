#!/bin/bash
function timestamp {
  minutes=`expr "$1" "/" "60000"`
  seconds=`expr "(" "$1" "/" "1000" ")" "%" "60"`
  frames=`expr "(" "(" "$1" "%" "1000" ")" "*" "75"  ")" "/" "1000"`
  printf "%02d:%02d:%02d" $minutes $seconds $frames
}
function missingChapters {
  if [[ "$1" == *$'\n[CHAPTER]\n'* ]]
  then
    return 1
  else
    return 0
  fi
}


for file in $*
do
        spaces=""
        tracks="0"
        outfile=${file%.*}".cue"
        metadump=`ffmpeg -v error -i "$file" -f ffmetadata pipe:1`
        if (missingChapters "$metadump")
        then
          echo "no chapters in $file" >&2
        else
          echo "REM generated by autocue 0.3" > $outfile
          IFS_OLD=$IFS
          IFS=$'\n'
          for line in $metadump; do
            echo $line
              if ([[ $line == "[CHAPTER]" ]]) then
                tracks=`expr "$tracks" + 1`
                if ([[ $tracks == "1" ]]) then #first track, create file header
                  spaces="    "
                  echo "FILE \"$(basename "$file")\" MP3" >> $outfile
                 fi
                echo "  TRACK $tracks AUDIO" >> $outfile
              elif ([[ $line == "title="* ]]) then
                title=${line:6} 
                echo "$spaces""TITLE \"$title\"" >> $outfile
              elif ([[ $line == "artist="* ]]) then
                publisher=${line:7} 
                echo "$spaces""PERFORMER \"$publisher\"" >> $outfile
              elif ([[ $line == "START="* ]]) then
                time_msec=${line:6} 
                ts=`timestamp $time_msec`
                echo "$spaces""INDEX 01 $ts" >> $outfile
              fi
          done <<< "$medadump"
          IFS=$IFS_OLD
          IFS_BAK=
          echo "created $outfile with $tracks tracks" >&2
        fi
done
