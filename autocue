#!/bin/bash
function timestamp {
  minutes=`expr "$1" "/" "60000"`
  seconds=`expr "(" "$1" "/" "1000" ")" "%" "60"`
  frames=`expr "(" "(" "$1" "%" "1000" ")" "*" "75"  ")" "/" "1000"`
  printf "%02d:%02d:%02d" $minutes $seconds $frames
}

for file in $*
do
        spaces=""
        tracks="0"
        outfile="$file.cue"
        echo "REM generated by autocue 0.1" > $outfile    
        ffmpeg -v error -i "$file" -f ffmetadata pipe:1 | while read line
        do
          if ([[ $line == "[CHAPTER]" ]]) then
            tracks=`expr "$tracks" + 1`
            if ([[ $tracks == "1" ]]) then #first track, create file header
              spaces="    "
              echo "FILE \"$(basename "$file")\" MP3" >> $outfile
             fi
            echo "  TRACK $tracks AUDIO" >> $outfile
          elif ([[ $line == "title="* ]]) then
            title=${line:6} 
            echo "$spaces""TITLE \"$title\"" >> $outfile
          elif ([[ $line == "artist="* ]]) then
            publisher=${line:7} 
            echo "$spaces""PERFORMER \"$publisher\"" >> $outfile
          elif ([[ $line == "START="* ]]) then
            time_msec=${line:6} 
            ts=`timestamp $time_msec`
            echo "$spaces""INDEX 01 $ts" >> $outfile
          fi
        done
done


